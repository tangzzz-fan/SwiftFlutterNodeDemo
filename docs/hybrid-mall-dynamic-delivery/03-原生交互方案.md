# 原生交互方案（JSBridge设计）

## 1. JSBridge架构设计

### 1.1 通信架构

```
┌────────────────────────────────────────────────────┐
│                   H5 Layer                         │
├────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────┐     │
│  │        NativeBridge SDK (TypeScript)     │     │
│  │  ┌────────────┐  ┌──────────────────┐   │     │
│  │  │ Call Queue │  │ Callback Manager │   │     │
│  │  └────────────┘  └──────────────────┘   │     │
│  └──────────────────────────────────────────┘     │
└────────────────────────────────────────────────────┘
                      ▲         │
                      │         │
          ┌───────────┘         └──────────┐
          │ JS→Native              Native→JS │
          │ (evaluateJavascript) (runJS)    │
          │                                  │
┌─────────▼──────────────────────────────────▼───────┐
│              WebView Communication Layer           │
└────────────────────────────────────────────────────┘
                      ▲         │
                      │         │
┌─────────────────────▼─────────▼─────────────────────┐
│                Flutter Layer                        │
├─────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────┐      │
│  │      JSBridgeService (Dart)              │      │
│  │  ┌────────────┐  ┌──────────────────┐   │      │
│  │  │   Method   │  │   Callback       │   │      │
│  │  │  Registry  │  │   Handler        │   │      │
│  │  └────────────┘  └──────────────────┘   │      │
│  └──────────────────────────────────────────┘      │
│                      │                              │
│  ┌───────────────────▼──────────────────────┐      │
│  │        Native Capabilities               │      │
│  │  (存储/网络/设备信息/路由跳转等)          │      │
│  └──────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────┘
```

### 1.2 消息协议设计

#### 标准消息格式

```typescript
interface BridgeMessage {
  id: string;              // 唯一消息ID
  method: string;          // 方法名
  params?: any;            // 参数
  callback?: string;       // 回调函数名
  timestamp: number;       // 时间戳
}

interface BridgeResponse {
  id: string;              // 对应请求的ID
  success: boolean;        // 是否成功
  data?: any;              // 返回数据
  error?: {
    code: number;
    message: string;
  };
  timestamp: number;
}
```

## 2. H5端实现（TypeScript）

### 2.1 NativeBridge SDK

```typescript
// mall_h5/src/bridge/native-bridge.ts

type CallbackFunction = (response: BridgeResponse) => void;

class NativeBridge {
  private callbackId = 0;
  private callbacks: Map<string, CallbackFunction> = new Map();
  private eventListeners: Map<string, Set<Function>> = new Map();
  
  constructor() {
    this.setupGlobalHandler();
  }
  
  /**
   * 设置全局消息处理器
   */
  private setupGlobalHandler() {
    // Flutter会调用这个全局函数来触发回调
    (window as any).__NATIVE_BRIDGE_CALLBACK__ = (response: BridgeResponse) => {
      const callback = this.callbacks.get(response.id);
      if (callback) {
        callback(response);
        this.callbacks.delete(response.id);
      }
    };
    
    // Native主动调用JS的处理器
    (window as any).__NATIVE_BRIDGE_EVENT__ = (event: string, data: any) => {
      this.triggerEvent(event, data);
    };
  }
  
  /**
   * 调用Native方法
   */
  async callNative<T = any>(
    method: string,
    params?: any
  ): Promise<T> {
    return new Promise((resolve, reject) => {
      const id = this.generateCallbackId();
      const message: BridgeMessage = {
        id,
        method,
        params,
        timestamp: Date.now(),
      };
      
      // 注册回调
      this.callbacks.set(id, (response: BridgeResponse) => {
        if (response.success) {
          resolve(response.data);
        } else {
          reject(new Error(response.error?.message || 'Unknown error'));
        }
      });
      
      // 设置超时
      setTimeout(() => {
        if (this.callbacks.has(id)) {
          this.callbacks.delete(id);
          reject(new Error('Native call timeout'));
        }
      }, 30000); // 30秒超时
      
      // 发送消息给Native
      this.postMessage(message);
    });
  }
  
  /**
   * 发送消息到Native
   */
  private postMessage(message: BridgeMessage) {
    if ((window as any).flutter_inappwebview) {
      // Flutter WebView方式1: flutter_inappwebview
      (window as any).flutter_inappwebview.callHandler(
        'nativeBridge',
        JSON.stringify(message)
      );
    } else if ((window as any).NativeBridge) {
      // Flutter WebView方式2: JavascriptChannel
      (window as any).NativeBridge.postMessage(JSON.stringify(message));
    } else {
      console.error('Native bridge not available');
    }
  }
  
  /**
   * 监听Native事件
   */
  on(event: string, listener: Function) {
    if (!this.eventListeners.has(event)) {
      this.eventListeners.set(event, new Set());
    }
    this.eventListeners.get(event)!.add(listener);
  }
  
  /**
   * 移除事件监听
   */
  off(event: string, listener?: Function) {
    if (!listener) {
      this.eventListeners.delete(event);
    } else {
      this.eventListeners.get(event)?.delete(listener);
    }
  }
  
  /**
   * 触发事件
   */
  private triggerEvent(event: string, data: any) {
    const listeners = this.eventListeners.get(event);
    if (listeners) {
      listeners.forEach(listener => listener(data));
    }
  }
  
  /**
   * 生成回调ID
   */
  private generateCallbackId(): string {
    return `cb_${++this.callbackId}_${Date.now()}`;
  }
}

// 全局单例
export const nativeBridge = new NativeBridge();
```

### 2.2 业务API封装

```typescript
// mall_h5/src/bridge/native-api.ts
import { nativeBridge } from './native-bridge';

export class NativeAPI {
  /**
   * 获取用户信息
   */
  static async getUserInfo(): Promise<UserInfo> {
    return nativeBridge.callNative('getUserInfo');
  }
  
  /**
   * 打开原生页面
   */
  static async navigateTo(page: string, params?: any): Promise<void> {
    return nativeBridge.callNative('navigateTo', { page, params });
  }
  
  /**
   * 显示Toast
   */
  static async showToast(message: string, duration = 2000): Promise<void> {
    return nativeBridge.callNative('showToast', { message, duration });
  }
  
  /**
   * 获取设备信息
   */
  static async getDeviceInfo(): Promise<DeviceInfo> {
    return nativeBridge.callNative('getDeviceInfo');
  }
  
  /**
   * 本地存储
   */
  static async setStorage(key: string, value: any): Promise<void> {
    return nativeBridge.callNative('setStorage', { key, value });
  }
  
  static async getStorage<T>(key: string): Promise<T | null> {
    return nativeBridge.callNative('getStorage', { key });
  }
  
  /**
   * 分享
   */
  static async share(data: ShareData): Promise<void> {
    return nativeBridge.callNative('share', data);
  }
  
  /**
   * 支付
   */
  static async pay(orderInfo: PaymentInfo): Promise<PaymentResult> {
    return nativeBridge.callNative('pay', orderInfo);
  }
  
  /**
   * 批量上报事件
   */
  static async batchReport(events: AnalyticsEvent[]): Promise<void> {
    return nativeBridge.callNative('batchReport', { events });
  }
}

// 监听Native事件示例
export function setupNativeListeners() {
  // 监听网络状态变化
  nativeBridge.on('networkStatusChanged', (status: string) => {
    console.log('Network status:', status);
  });
  
  // 监听主题变化
  nativeBridge.on('themeChanged', (theme: 'light' | 'dark') => {
    console.log('Theme changed to:', theme);
  });
  
  // 监听页面可见性
  nativeBridge.on('pageVisibilityChanged', (visible: boolean) => {
    console.log('Page visible:', visible);
  });
}
```

### 2.3 事件上报器（大数据量优化）

```typescript
// mall_h5/src/bridge/event-reporter.ts
import { NativeAPI } from './native-api';

interface AnalyticsEvent {
  type: string;
  data: any;
  timestamp: number;
}

export class EventReporter {
  private queue: AnalyticsEvent[] = [];
  private readonly BATCH_SIZE = 50;
  private readonly FLUSH_INTERVAL = 5000; // 5秒
  private timer: NodeJS.Timeout | null = null;
  
  constructor() {
    this.startAutoFlush();
  }
  
  /**
   * 上报单个事件
   */
  report(type: string, data: any) {
    const event: AnalyticsEvent = {
      type,
      data,
      timestamp: Date.now(),
    };
    
    this.queue.push(event);
    
    // 达到批量大小时立即发送
    if (this.queue.length >= this.BATCH_SIZE) {
      this.flush();
    }
  }
  
  /**
   * 批量上报页面浏览事件
   */
  reportPageView(page: string, params?: any) {
    this.report('page_view', { page, params });
  }
  
  /**
   * 上报点击事件
   */
  reportClick(element: string, params?: any) {
    this.report('click', { element, params });
  }
  
  /**
   * 上报商品曝光
   */
  reportProductExposure(productIds: string[]) {
    this.report('product_exposure', { productIds });
  }
  
  /**
   * 立即发送所有待上报事件
   */
  async flush() {
    if (this.queue.length === 0) return;
    
    const batch = this.queue.splice(0, this.BATCH_SIZE);
    
    try {
      await NativeAPI.batchReport(batch);
      console.log(`Flushed ${batch.length} events`);
    } catch (error) {
      console.error('Failed to report events:', error);
      // 失败的事件重新加入队列（放到最前面）
      this.queue.unshift(...batch);
    }
  }
  
  /**
   * 启动自动刷新
   */
  private startAutoFlush() {
    this.timer = setInterval(() => {
      this.flush();
    }, this.FLUSH_INTERVAL);
  }
  
  /**
   * 停止自动刷新
   */
  stop() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
    // 停止前发送剩余事件
    this.flush();
  }
}

// 全局单例
export const eventReporter = new EventReporter();

// 页面卸载时发送剩余事件
window.addEventListener('beforeunload', () => {
  eventReporter.flush();
});
```

## 3. Flutter端实现（Dart）

### 3.1 JSBridge服务

```dart
// lib/hybrid/services/jsbridge_service.dart
import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';
import 'dart:convert';

class JSBridgeService {
  final WebViewController _controller;
  final Map<String, JSBridgeHandler> _handlers = {};
  
  JSBridgeService(this._controller) {
    _registerDefaultHandlers();
  }
  
  /// 注册默认处理器
  void _registerDefaultHandlers() {
    // 用户信息
    registerHandler('getUserInfo', _handleGetUserInfo);
    
    // 导航
    registerHandler('navigateTo', _handleNavigateTo);
    
    // Toast
    registerHandler('showToast', _handleShowToast);
    
    // 设备信息
    registerHandler('getDeviceInfo', _handleGetDeviceInfo);
    
    // 本地存储
    registerHandler('setStorage', _handleSetStorage);
    registerHandler('getStorage', _handleGetStorage);
    
    // 分享
    registerHandler('share', _handleShare);
    
    // 支付
    registerHandler('pay', _handlePay);
    
    // 批量上报
    registerHandler('batchReport', _handleBatchReport);
  }
  
  /// 注册方法处理器
  void registerHandler(String method, JSBridgeHandler handler) {
    _handlers[method] = handler;
  }
  
  /// 处理来自JS的消息
  Future<void> handleMessage(String messageJson) async {
    try {
      final message = json.decode(messageJson) as Map<String, dynamic>;
      final id = message['id'] as String;
      final method = message['method'] as String;
      final params = message['params'];
      
      // 查找处理器
      final handler = _handlers[method];
      if (handler == null) {
        await _sendResponse(id, success: false, error: {
          'code': -1,
          'message': 'Method not found: $method'
        });
        return;
      }
      
      // 执行处理器
      try {
        final result = await handler(params);
        await _sendResponse(id, success: true, data: result);
      } catch (e) {
        await _sendResponse(id, success: false, error: {
          'code': -2,
          'message': e.toString()
        });
      }
    } catch (e) {
      print('Failed to handle bridge message: $e');
    }
  }
  
  /// 发送响应到JS
  Future<void> _sendResponse(
    String id, {
    required bool success,
    dynamic data,
    Map<String, dynamic>? error,
  }) async {
    final response = {
      'id': id,
      'success': success,
      'data': data,
      'error': error,
      'timestamp': DateTime.now().millisecondsSinceEpoch,
    };
    
    final responseJson = json.encode(response);
    await _controller.runJavaScript(
      'window.__NATIVE_BRIDGE_CALLBACK__($responseJson)'
    );
  }
  
  /// 主动调用JS方法
  Future<void> callJS(String event, dynamic data) async {
    final dataJson = json.encode(data);
    await _controller.runJavaScript(
      'window.__NATIVE_BRIDGE_EVENT__("$event", $dataJson)'
    );
  }
  
  // ========== 处理器实现 ==========
  
  Future<Map<String, dynamic>> _handleGetUserInfo(dynamic params) async {
    // 从本地存储或状态管理中获取用户信息
    return {
      'userId': '12345',
      'username': 'testuser',
      'avatar': 'https://example.com/avatar.jpg',
    };
  }
  
  Future<void> _handleNavigateTo(dynamic params) async {
    final page = params['page'] as String;
    final pageParams = params['params'];
    
    // 使用Flutter的导航系统
    // Navigator.of(context).pushNamed(page, arguments: pageParams);
    
    print('Navigate to: $page with params: $pageParams');
  }
  
  Future<void> _handleShowToast(dynamic params) async {
    final message = params['message'] as String;
    final duration = params['duration'] as int? ?? 2000;
    
    // 显示Toast（需要BuildContext）
    print('Show toast: $message');
  }
  
  Future<Map<String, dynamic>> _handleGetDeviceInfo(dynamic params) async {
    return {
      'platform': 'iOS', // 或 'Android'
      'version': '17.0',
      'model': 'iPhone 14 Pro',
      'appVersion': '1.0.0',
    };
  }
  
  Future<void> _handleSetStorage(dynamic params) async {
    final key = params['key'] as String;
    final value = params['value'];
    
    // 使用SharedPreferences存储
    // await prefs.setString(key, json.encode(value));
    
    print('Set storage: $key = $value');
  }
  
  Future<dynamic> _handleGetStorage(dynamic params) async {
    final key = params['key'] as String;
    
    // 从SharedPreferences读取
    // final value = prefs.getString(key);
    // return value != null ? json.decode(value) : null;
    
    return null;
  }
  
  Future<void> _handleShare(dynamic params) async {
    final title = params['title'] as String?;
    final content = params['content'] as String?;
    final url = params['url'] as String?;
    
    // 调用原生分享
    print('Share: $title, $content, $url');
  }
  
  Future<Map<String, dynamic>> _handlePay(dynamic params) async {
    final orderId = params['orderId'] as String;
    final amount = params['amount'] as num;
    
    // 调用支付SDK
    print('Pay: order=$orderId, amount=$amount');
    
    return {
      'success': true,
      'transactionId': 'txn_123456',
    };
  }
  
  Future<void> _handleBatchReport(dynamic params) async {
    final events = params['events'] as List<dynamic>;
    
    // 批量处理事件上报
    print('Batch report: ${events.length} events');
    
    // 这里可以：
    // 1. 写入本地数据库
    // 2. 批量发送到服务器
    // 3. 触发分析服务
  }
}

typedef JSBridgeHandler = Future<dynamic> Function(dynamic params);
```

### 3.2 WebView集成

```dart
// lib/hybrid/widgets/mall_webview.dart
import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';
import '../services/jsbridge_service.dart';

class MallWebView extends StatefulWidget {
  final String url;
  
  const MallWebView({
    Key? key,
    required this.url,
  }) : super(key: key);
  
  @override
  State<MallWebView> createState() => _MallWebViewState();
}

class _MallWebViewState extends State<MallWebView> {
  late final WebViewController _controller;
  late final JSBridgeService _bridgeService;
  bool _isLoading = true;
  
  @override
  void initState() {
    super.initState();
    _initWebView();
  }
  
  void _initWebView() {
    _controller = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setBackgroundColor(Colors.white)
      ..setNavigationDelegate(
        NavigationDelegate(
          onPageStarted: (url) {
            setState(() => _isLoading = true);
          },
          onPageFinished: (url) {
            setState(() => _isLoading = false);
            _injectBridge();
          },
          onWebResourceError: (error) {
            print('WebView error: ${error.description}');
          },
        ),
      )
      ..loadRequest(Uri.parse(widget.url));
    
    // 添加JavaScript Channel
    _controller.addJavaScriptChannel(
      'NativeBridge',
      onMessageReceived: (JavaScriptMessage message) {
        _bridgeService.handleMessage(message.message);
      },
    );
    
    _bridgeService = JSBridgeService(_controller);
  }
  
  /// 注入Bridge初始化脚本
  Future<void> _injectBridge() async {
    await _controller.runJavaScript('''
      (function() {
        console.log('Native Bridge initialized');
        
        // 通知H5 Bridge已就绪
        if (window.onNativeBridgeReady) {
          window.onNativeBridgeReady();
        }
        
        // 触发自定义事件
        window.dispatchEvent(new Event('nativeBridgeReady'));
      })();
    ''');
  }
  
  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        WebViewWidget(controller: _controller),
        if (_isLoading)
          const Center(
            child: CircularProgressIndicator(),
          ),
      ],
    );
  }
}
```

## 4. 使用示例

### 4.1 H5端调用Native

```typescript
// mall_h5/src/pages/home/index.tsx
import { NativeAPI } from '@/bridge/native-api';
import { eventReporter } from '@/bridge/event-reporter';

export function HomePage() {
  // 获取用户信息
  const loadUserInfo = async () => {
    try {
      const userInfo = await NativeAPI.getUserInfo();
      console.log('User info:', userInfo);
    } catch (error) {
      console.error('Failed to get user info:', error);
    }
  };
  
  // 打开原生页面
  const openNativePage = async () => {
    await NativeAPI.navigateTo('profile', { userId: '123' });
  };
  
  // 显示Toast
  const showMessage = async () => {
    await NativeAPI.showToast('Hello from H5!');
  };
  
  // 上报点击事件
  const handleProductClick = (productId: string) => {
    eventReporter.reportClick('product_card', { productId });
  };
  
  return (
    <div>
      <button onClick={loadUserInfo}>获取用户信息</button>
      <button onClick={openNativePage}>打开原生页面</button>
      <button onClick={showMessage}>显示消息</button>
      <div onClick={() => handleProductClick('p001')}>
        商品卡片
      </div>
    </div>
  );
}
```

### 4.2 Native主动调用JS

```dart
// Flutter端代码
class MallController {
  final JSBridgeService _bridge;
  
  /// 通知H5网络状态变化
  Future<void> notifyNetworkStatusChanged(String status) async {
    await _bridge.callJS('networkStatusChanged', status);
  }
  
  /// 通知H5主题变化
  Future<void> notifyThemeChanged(String theme) async {
    await _bridge.callJS('themeChanged', theme);
  }
  
  /// 通知H5用户信息更新
  Future<void> notifyUserInfoUpdated(Map<String, dynamic> userInfo) async {
    await _bridge.callJS('userInfoUpdated', userInfo);
  }
}
```

```typescript
// H5端监听
import { nativeBridge } from '@/bridge/native-bridge';

nativeBridge.on('networkStatusChanged', (status: string) => {
  if (status === 'offline') {
    // 显示离线提示
    showOfflineNotice();
  }
});

nativeBridge.on('userInfoUpdated', (userInfo: any) => {
  // 更新本地状态
  updateUserState(userInfo);
});
```

## 5. 性能优化

### 5.1 消息批量处理

```dart
class OptimizedJSBridge extends JSBridgeService {
  final List<Map<String, dynamic>> _messageQueue = [];
  Timer? _flushTimer;
  
  @override
  Future<void> handleMessage(String messageJson) async {
    final message = json.decode(messageJson);
    _messageQueue.add(message);
    
    // 批量处理（降低通信频率）
    if (_messageQueue.length >= 10) {
      await _flushMessages();
    } else {
      _scheduleFlush();
    }
  }
  
  void _scheduleFlush() {
    _flushTimer?.cancel();
    _flushTimer = Timer(Duration(milliseconds: 100), _flushMessages);
  }
  
  Future<void> _flushMessages() async {
    if (_messageQueue.isEmpty) return;
    
    final batch = List<Map<String, dynamic>>.from(_messageQueue);
    _messageQueue.clear();
    
    // 并行处理所有消息
    await Future.wait(
      batch.map((msg) => super.handleMessage(json.encode(msg)))
    );
  }
}
```

### 5.2 大数据传输优化

```typescript
// 压缩大数据
import pako from 'pako';

class DataCompressor {
  static compress(data: any): string {
    const json = JSON.stringify(data);
    const compressed = pako.deflate(json);
    return btoa(String.fromCharCode(...compressed));
  }
  
  static decompress(compressed: string): any {
    const binary = atob(compressed);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    const decompressed = pako.inflate(bytes, { to: 'string' });
    return JSON.parse(decompressed);
  }
}

// 使用示例
const largeData = { /* 大量数据 */ };
const compressed = DataCompressor.compress(largeData);
await NativeAPI.sendLargeData(compressed);
```

## 6. 安全性考虑

### 6.1 方法白名单

```dart
class SecureJSBridge extends JSBridgeService {
  static const _allowedMethods = {
    'getUserInfo',
    'navigateTo',
    'showToast',
    'getDeviceInfo',
    'setStorage',
    'getStorage',
    'share',
    'batchReport',
  };
  
  @override
  Future<void> handleMessage(String messageJson) async {
    final message = json.decode(messageJson);
    final method = message['method'] as String;
    
    // 检查方法是否在白名单中
    if (!_allowedMethods.contains(method)) {
      await _sendResponse(
        message['id'],
        success: false,
        error: {'code': -403, 'message': 'Method not allowed'},
      );
      return;
    }
    
    await super.handleMessage(messageJson);
  }
}
```

### 6.2 参数验证

```dart
Future<Map<String, dynamic>> _handlePayWithValidation(dynamic params) async {
  // 验证必需参数
  if (params == null || params is! Map) {
    throw ArgumentError('Invalid params');
  }
  
  final orderId = params['orderId'] as String?;
  final amount = params['amount'] as num?;
  
  if (orderId == null || orderId.isEmpty) {
    throw ArgumentError('orderId is required');
  }
  
  if (amount == null || amount <= 0) {
    throw ArgumentError('Invalid amount');
  }
  
  // 执行支付逻辑
  return await _performPayment(orderId, amount);
}
```

## 7. 调试工具

### 7.1 Bridge调试器

```typescript
// mall_h5/src/bridge/debug.ts
class BridgeDebugger {
  private logs: any[] = [];
  
  enable() {
    const originalCallNative = nativeBridge.callNative;
    
    nativeBridge.callNative = async (method: string, params?: any) => {
      const startTime = Date.now();
      console.log('[Bridge] →', method, params);
      
      try {
        const result = await originalCallNative.call(nativeBridge, method, params);
        const duration = Date.now() - startTime;
        console.log('[Bridge] ←', method, result, `(${duration}ms)`);
        
        this.logs.push({
          type: 'call',
          method,
          params,
          result,
          duration,
          timestamp: Date.now(),
        });
        
        return result;
      } catch (error) {
        console.error('[Bridge] ✗', method, error);
        throw error;
      }
    };
  }
  
  getLogs() {
    return this.logs;
  }
  
  clearLogs() {
    this.logs = [];
  }
}

export const bridgeDebugger = new BridgeDebugger();

// 开发环境启用
if (process.env.NODE_ENV === 'development') {
  bridgeDebugger.enable();
}
```

## 下一步

详见：[性能优化方案](./04-性能优化方案.md)

