# 整体架构设计

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Flutter Shell│  │ WebView Pool │  │  JSBridge    │     │
│  │  (壳工程)    │  │  (容器池)    │  │  (通信层)    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│           │                │                  │             │
│  ┌────────▼────────────────▼──────────────────▼──────┐     │
│  │         资源管理模块（下载/校验/加载）            │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │ HTTPS
                              │
┌─────────────────────────────▼─────────────────────────────┐
│                       服务端层                             │
├───────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  资源服务器  │  │  版本管理API │  │  日志收集器  │   │
│  │ (静态资源)   │  │  (版本控制)  │  │  (监控上报)  │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└───────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼─────────────────────────────┐
│                       存储层                               │
├───────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐                      │
│  │  资源包存储  │  │  版本元数据  │                      │
│  │  (文件系统)  │  │  (JSON/DB)   │                      │
│  └──────────────┘  └──────────────┘                      │
└───────────────────────────────────────────────────────────┘
```

## 2. 核心模块设计

### 2.1 资源管理模块

```dart
// 核心职责
class ResourceManager {
  // 1. 版本检查
  Future<VersionInfo> checkVersion();
  
  // 2. 资源下载
  Future<void> downloadResource(String version);
  
  // 3. 完整性校验
  Future<bool> verifyResource(String path, String hash);
  
  // 4. 原子化应用
  Future<void> applyResource(String version);
  
  // 5. 回滚机制
  Future<void> rollback();
}
```

### 2.2 WebView容器模块

```dart
class WebViewContainer {
  // 1. WebView池管理
  WebViewPool _pool;
  
  // 2. 预加载
  Future<void> preloadWebView(String url);
  
  // 3. 获取/复用WebView
  WebView getOrCreateWebView();
  
  // 4. 生命周期管理
  void onPause/onResume/onDestroy();
}
```

### 2.3 JSBridge通信模块

```dart
class JSBridge {
  // 1. 注册原生方法
  void registerMethod(String name, Function handler);
  
  // 2. 调用JS方法
  Future<T> callJSMethod(String name, dynamic params);
  
  // 3. 回调管理
  CallbackManager _callbacks;
  
  // 4. 批量上报优化
  void batchReport(List<Event> events);
}
```

### 2.4 容错降级模块

```dart
class FallbackManager {
  // 1. 错误捕获
  void catchWebViewError(Error error);
  
  // 2. 降级策略
  Widget getFallbackWidget();
  
  // 3. 日志上报
  void reportError(Error error);
  
  // 4. 本地缓存降级
  String getLocalFallbackHTML();
}
```

## 3. 技术选型

### 3.1 Flutter依赖库

| 库名 | 版本 | 用途 |
|------|------|------|
| webview_flutter | ^4.4.0 | WebView容器 |
| webview_flutter_wkwebview | ^3.9.0 | iOS WKWebView |
| webview_flutter_android | ^3.12.0 | Android WebView |
| dio | ^5.4.0 | HTTP客户端（已有） |
| crypto | ^3.0.3 | 完整性校验（已有） |
| path_provider | ^2.1.0 | 文件路径管理 |
| shared_preferences | ^2.2.2 | 本地配置（已有） |
| package_info_plus | ^5.0.0 | 应用版本信息 |
| connectivity_plus | ^5.0.0 | 网络状态检测 |

### 3.2 H5技术栈（推荐）

**方案1: Vue 3 + Vite**
```javascript
// 优点：轻量、生态成熟、构建快
{
  "vue": "^3.4.0",
  "vite": "^5.0.0",
  "typescript": "^5.3.0",
  "@vueuse/core": "^10.0.0"  // 工具库
}
```

**方案2: React 18 + Vite**
```javascript
// 优点：性能好、并发渲染
{
  "react": "^18.2.0",
  "vite": "^5.0.0",
  "typescript": "^5.3.0"
}
```

### 3.3 后端服务扩展

```json
{
  "multer": "^1.4.5-lts.1",    // 文件上传
  "archiver": "^6.0.0",         // 压缩打包
  "md5-file": "^5.0.0",         // MD5计算
  "serve-static": "^1.15.0"     // 静态资源服务
}
```

## 4. 数据流设计

### 4.1 资源下发流程

```
┌─────────┐     ①检查版本      ┌─────────┐
│ Flutter │ ─────────────────> │  Server │
│  Client │                    │   API   │
└─────────┘                    └─────────┘
     │                              │
     │        ②返回版本信息          │
     │ <─────────────────────────── │
     │                              │
     │        ③下载资源包            │
     │ ────────────────────────────>│
     │                              │
     │        ④流式下载              │
     │ <════════════════════════════│
     │                              │
     ▼                              │
┌─────────┐                         │
│ 本地存储 │                         │
│ (临时)  │                         │
└─────────┘                         │
     │                              │
     │  ⑤ 校验MD5                   │
     ▼                              │
┌─────────┐                         │
│ 解压缩  │                         │
└─────────┘                         │
     │                              │
     │  ⑥ 原子化应用（重命名）       │
     ▼                              │
┌─────────┐                         │
│ 正式目录 │                         │
└─────────┘                         │
```

### 4.2 JSBridge通信流程

```
┌─────────┐                    ┌─────────┐
│   H5    │                    │ Flutter │
└─────────┘                    └─────────┘
     │                              │
     │  ① callNative('getUserInfo',│
     │     { params }, callback)   │
     │ ────────────────────────────>│
     │                              │
     │                              ▼
     │                         执行Native方法
     │                              │
     │  ② 回调返回                  │
     │ <────────────────────────────│
     │                              │
     │                              │
     │  ③ Native主动调用JS          │
     │ <════════════════════════════│
     │  window.jsHandler.onUpdate() │
     │                              │
     ▼                              │
  JS处理回调                         │
```

## 5. 目录结构设计

### 5.1 Flutter项目结构

```
flutter_module/
├── lib/
│   ├── hybrid/                    # 混合开发模块（新增）
│   │   ├── models/
│   │   │   ├── resource_info.dart       # 资源包信息
│   │   │   ├── version_info.dart        # 版本信息
│   │   │   └── jsbridge_message.dart    # 通信消息
│   │   ├── services/
│   │   │   ├── resource_manager.dart    # 资源管理器
│   │   │   ├── webview_pool.dart        # WebView池
│   │   │   ├── jsbridge_service.dart    # JSBridge服务
│   │   │   └── fallback_manager.dart    # 降级管理
│   │   ├── widgets/
│   │   │   ├── mall_webview.dart        # 商城WebView组件
│   │   │   ├── skeleton_screen.dart     # 骨架屏
│   │   │   └── error_page.dart          # 错误页面
│   │   └── controllers/
│   │       └── mall_controller.dart     # 商城控制器
│   └── screens/
│       └── hybrid_mall_screen.dart      # 商城页面
└── assets/
    └── hybrid/
        ├── skeleton.html              # 骨架屏HTML
        └── fallback.html              # 降级页面
```

### 5.2 后端项目结构

```
backend_module/
├── src/
│   ├── controllers/
│   │   └── ResourceController.ts      # 资源管理控制器（新增）
│   ├── routes/
│   │   └── resource.routes.ts         # 资源路由（新增）
│   └── services/
│       └── ResourceService.ts         # 资源服务（新增）
└── public/                            # 静态资源目录（新增）
    └── mall/
        ├── versions/
        │   ├── v1.0.0/
        │   │   ├── index.html
        │   │   ├── assets/
        │   │   └── manifest.json
        │   └── v1.0.1/
        └── packages/
            ├── mall-v1.0.0.zip
            └── mall-v1.0.1.zip
```

### 5.3 H5项目结构

```
mall_h5/                               # 商城H5项目（新增）
├── src/
│   ├── pages/
│   │   ├── home/                      # 首页
│   │   ├── product/                   # 商品详情
│   │   └── cart/                      # 购物车
│   ├── bridge/
│   │   └── native-bridge.ts           # JSBridge封装
│   ├── utils/
│   │   └── reporter.ts                # 事件上报
│   └── main.ts
├── public/
├── vite.config.ts
└── package.json
```

## 6. 关键技术点

### 6.1 原子化更新

采用"下载到临时目录 → 校验 → 原子重命名"策略，确保更新过程中应用始终可用。

```dart
// 伪代码
Future<void> atomicUpdate(String newVersion) async {
  final tempDir = '${cacheDir}/temp_${newVersion}';
  final targetDir = '${cacheDir}/${newVersion}';
  
  // 1. 下载到临时目录
  await downloadTo(tempDir);
  
  // 2. 校验完整性
  if (!await verify(tempDir)) {
    await deleteDirectory(tempDir);
    throw Exception('Verification failed');
  }
  
  // 3. 原子重命名（系统级操作，要么成功要么失败）
  await Directory(tempDir).rename(targetDir);
  
  // 4. 更新当前版本指针
  await updateVersionPointer(newVersion);
}
```

### 6.2 WebView池预加载

```dart
class WebViewPool {
  final Map<String, WebViewController> _pool = {};
  final int maxPoolSize = 3;
  
  Future<void> preload(String url) async {
    if (_pool.length >= maxPoolSize) {
      _evictOldest();
    }
    
    final controller = WebViewController();
    await controller.loadRequest(Uri.parse(url));
    _pool[url] = controller;
  }
  
  WebViewController? get(String url) {
    return _pool.remove(url);
  }
}
```

### 6.3 高效数据传输

对于大数据量（如事件上报），采用：
1. **批量上报**: 累积到一定量级或时间间隔后批量发送
2. **数据压缩**: gzip压缩JSON数据
3. **异步处理**: 不阻塞主线程

```javascript
// H5端批量上报
class EventReporter {
  private queue: Event[] = [];
  private readonly BATCH_SIZE = 50;
  private readonly FLUSH_INTERVAL = 5000; // 5秒
  
  report(event: Event) {
    this.queue.push(event);
    
    if (this.queue.length >= this.BATCH_SIZE) {
      this.flush();
    }
  }
  
  async flush() {
    if (this.queue.length === 0) return;
    
    const batch = this.queue.splice(0, this.BATCH_SIZE);
    await window.NativeBridge.batchReport(batch);
  }
}
```

## 7. 性能指标定义

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 首屏加载时间 | < 300ms | WebView显示到内容可见 |
| 资源下载速度 | > 2MB/s | 在良好网络环境下 |
| 内存占用 | < 150MB | 包含WebView和资源 |
| 秒开成功率 | > 95% | 使用WebView池后 |
| Crash率 | < 0.1% | 每千次访问崩溃次数 |

## 8. 安全性考虑

1. **HTTPS传输**: 所有资源下载必须使用HTTPS
2. **完整性校验**: SHA256校验资源包
3. **签名验证**: 对manifest.json进行数字签名（可选）
4. **沙箱隔离**: H5运行在受限环境，限制敏感API访问
5. **白名单机制**: JSBridge只暴露白名单内的方法

## 下一步

详见：
- [资源包管理方案](./02-资源包管理方案.md)
- [原生交互方案](./03-原生交互方案.md)

