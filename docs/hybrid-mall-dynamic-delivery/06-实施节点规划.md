# 实施节点规划

## 1. 项目总览

### 1.1 实施周期

**总工期**: 约15个工作日（3周）

**团队配置建议**：
- 后端开发 1人
- Flutter开发 1人  
- H5前端开发 1人
- 测试 1人（可兼职）

### 1.2 关键里程碑

```
Week 1: 基础设施搭建
  ├─ Day 1-2: 后端资源服务
  ├─ Day 3-4: Flutter资源管理
  └─ Day 5: H5商城资源包

Week 2: 核心功能实现
  ├─ Day 6-7: JSBridge通信
  ├─ Day 8-9: 资源下载加载
  └─ Day 10: 集成测试

Week 3: 优化与加固
  ├─ Day 11-12: 性能优化
  ├─ Day 13-14: 容错降级
  └─ Day 15: 总体验收
```

## 2. 阶段一：基础设施搭建（Day 1-5）

### 2.1 后端资源服务（Day 1-2）

#### Day 1 上午：项目初始化
**任务**：
- [ ] 创建资源目录结构 `/public/mall`
- [ ] 设计版本管理数据结构
- [ ] 创建 `ResourceController` 和 `ResourceService`

**产出**：
- 目录结构创建完成
- 基础代码框架

**验收标准**：
- 目录结构符合规范
- 能启动服务不报错

#### Day 1 下午：版本检查API
**任务**：
- [ ] 实现 `GET /api/resource/version/check` 接口
- [ ] 实现版本比较逻辑
- [ ] 编写单元测试

**产出**：
- 版本检查API
- 测试用例

**验收标准**：
- Postman测试通过
- 返回正确的版本信息

#### Day 2 上午：资源服务API
**任务**：
- [ ] 实现资源包下载接口
- [ ] 实现manifest获取接口
- [ ] 配置静态资源服务

**产出**：
- 完整的资源服务API

**验收标准**：
- 能通过URL下载资源包
- manifest.json返回正确

#### Day 2 下午：工具脚本
**任务**：
- [ ] 编写资源打包脚本
- [ ] 实现SHA256计算工具
- [ ] 生成manifest.json工具

**产出**：
- `build-package.js` 打包脚本
- 自动化工具链

**验收标准**：
- 一键生成标准资源包
- 自动计算checksum

---

### 2.2 Flutter资源管理（Day 3-4）

#### Day 3 上午：数据模型
**任务**：
- [ ] 创建 `VersionInfo` 模型
- [ ] 创建 `ResourceInfo` 模型
- [ ] 创建 `DownloadState` 状态类

**产出**：
- `lib/hybrid/models/` 下的数据模型

**验收标准**：
- 模型字段完整
- JSON序列化/反序列化正常

#### Day 3 下午：资源下载器
**任务**：
- [ ] 实现 `ResourceDownloader` 类
- [ ] 支持进度回调
- [ ] 支持断点续传（可选）

**产出**：
- `resource_downloader.dart`

**验收标准**：
- 能下载文件并显示进度
- 网络中断后能恢复

#### Day 4 上午：资源校验与解压
**任务**：
- [ ] 实现 `ResourceVerifier` 校验工具
- [ ] 实现资源解压功能
- [ ] 添加 `archive` 依赖

**产出**：
- `resource_verifier.dart`
- 解压功能

**验收标准**：
- SHA256校验准确
- 能正确解压zip文件

#### Day 4 下午：资源管理器
**任务**：
- [ ] 实现 `ResourceManager` 核心类
- [ ] 实现版本切换逻辑
- [ ] 实现原子化安装

**产出**：
- `resource_manager.dart`
- 完整的资源管理能力

**验收标准**：
- 能完整执行：检查→下载→校验→安装
- 版本切换不影响当前使用

---

### 2.3 H5商城资源包（Day 5）

#### Day 5 上午：项目搭建
**任务**：
- [ ] 创建 `mall_h5` 项目（React + Vite）
- [ ] 配置TypeScript
- [ ] 配置打包输出路径

**产出**：
- H5项目骨架
- `vite.config.ts` 配置

**验收标准**：
- `npm run dev` 能启动
- `npm run build` 能打包

#### Day 5 下午：基础页面
**任务**：
- [ ] 创建首页布局
- [ ] 创建简单的商品列表
- [ ] 引入基础样式

**产出**：
- 首页HTML
- 基础CSS

**验收标准**：
- 页面能在浏览器正常显示
- 打包后体积 < 500KB

---

## 3. 阶段二：核心功能实现（Day 6-10）

### 3.1 JSBridge通信（Day 6-7）

#### Day 6 上午：H5端Bridge SDK
**任务**：
- [ ] 创建 `NativeBridge` 类
- [ ] 实现 `callNative` 方法
- [ ] 实现回调管理器

**产出**：
- `native-bridge.ts`

**验收标准**：
- 能发送消息到Native
- 超时机制正常

#### Day 6 下午：Flutter端Bridge服务
**任务**：
- [ ] 创建 `JSBridgeService` 类
- [ ] 注册JavaScriptChannel
- [ ] 实现消息路由

**产出**：
- `jsbridge_service.dart`

**验收标准**：
- 能接收来自H5的消息
- 消息格式解析正确

#### Day 7 上午：业务方法实现
**任务**：
- [ ] 实现 `getUserInfo`
- [ ] 实现 `navigateTo`
- [ ] 实现 `showToast`
- [ ] 实现 `getDeviceInfo`

**产出**：
- 4个业务方法

**验收标准**：
- H5调用能得到正确响应
- 参数传递正确

#### Day 7 下午：双向通信测试
**任务**：
- [ ] H5调用Native方法
- [ ] Native主动调用JS
- [ ] 测试回调机制

**产出**：
- 完整的通信demo

**验收标准**：
- 双向通信流畅
- 无消息丢失

---

### 3.2 完整加载流程（Day 8-9）

#### Day 8 上午：WebView容器
**任务**：
- [ ] 创建 `MallWebView` 组件
- [ ] 集成JSBridge
- [ ] 处理页面生命周期

**产出**：
- `mall_webview.dart`

**验收标准**：
- WebView能正常显示
- Bridge自动注入

#### Day 8 下午：资源加载集成
**任务**：
- [ ] 集成 `ResourceManager`
- [ ] 实现启动时版本检查
- [ ] 加载本地资源到WebView

**产出**：
- 完整加载流程

**验收标准**：
- 能加载本地H5资源
- 版本检查正常

#### Day 9 全天：完整流程打通
**任务**：
- [ ] 后端上传新版本资源包
- [ ] Flutter检查并下载
- [ ] 校验、解压、加载
- [ ] H5与Native交互

**产出**：
- 端到端Demo

**验收标准**：
- 完整流程无阻塞
- 能演示动态更新

---

### 3.3 集成测试（Day 10）

#### Day 10 上午：功能测试
**测试清单**：
- [ ] 首次安装下载资源
- [ ] 版本更新流程
- [ ] 资源校验失败处理
- [ ] 网络异常处理
- [ ] JSBridge所有方法

#### Day 10 下午：问题修复
**任务**：
- [ ] 修复测试发现的问题
- [ ] 优化用户体验
- [ ] 代码清理

**产出**：
- Bug修复列表
- 测试报告

---

## 4. 阶段三：优化与加固（Day 11-15）

### 4.1 性能优化（Day 11-12）

#### Day 11 上午：骨架屏
**任务**：
- [ ] 设计骨架屏HTML
- [ ] 实现首屏占位
- [ ] JS注入骨架屏

**产出**：
- `skeleton.html`
- 注入逻辑

**验收标准**：
- 加载时立即显示骨架屏
- 内容加载后平滑过渡

#### Day 11 下午：WebView池
**任务**：
- [ ] 实现 `WebViewPool` 类
- [ ] 实现预加载机制
- [ ] 实现复用逻辑

**产出**：
- `webview_pool.dart`

**验收标准**：
- 池中最多3个WebView
- 复用时加载时间 < 100ms

#### Day 12 上午：资源预加载
**任务**：
- [ ] 关键资源预加载
- [ ] DNS预解析
- [ ] 图片懒加载

**产出**：
- 预加载策略

**验收标准**：
- 首屏时间降低30%

#### Day 12 下午：性能测试
**任务**：
- [ ] 测量首屏时间
- [ ] 测量内存占用
- [ ] 压力测试

**产出**：
- 性能测试报告

**验收标准**：
- 首屏 < 300ms
- 内存 < 150MB

---

### 4.2 容错降级（Day 13-14）

#### Day 13 上午：降级策略
**任务**：
- [ ] 实现版本回退逻辑
- [ ] 创建内置兜底资源
- [ ] 实现降级决策

**产出**：
- `FallbackManager` 类
- 兜底HTML

**验收标准**：
- 新版本失败能自动降级
- 降级流程顺畅

#### Day 13 下午：错误捕获
**任务**：
- [ ] WebView错误监听
- [ ] H5全局错误捕获
- [ ] Crash检测

**产出**：
- 完整错误捕获体系

**验收标准**：
- 所有错误都能捕获
- 不影响用户体验

#### Day 14 上午：错误上报
**任务**：
- [ ] 实现日志收集
- [ ] 实现批量上报
- [ ] 本地日志存储

**产出**：
- 日志上报系统

**验收标准**：
- 错误能上报到服务器
- 批量上报不阻塞主线程

#### Day 14 下午：异常场景测试
**测试清单**：
- [ ] 无网络启动
- [ ] 下载中断
- [ ] 校验失败
- [ ] WebView Crash
- [ ] 内存不足

**产出**：
- 异常测试报告

---

### 4.3 总体验收（Day 15）

#### Day 15 上午：功能验收
**验收清单**：
- [ ] 资源动态下发 ✅
- [ ] 版本管理和校验 ✅
- [ ] 原子化更新 ✅
- [ ] H5调用Native ✅
- [ ] Native调用JS ✅
- [ ] 双向回调 ✅
- [ ] 大数据量上报 ✅
- [ ] 骨架屏 ✅
- [ ] WebView池 ✅
- [ ] 秒开优化 ✅
- [ ] 错误降级 ✅
- [ ] Crash防护 ✅

#### Day 15 下午：文档与交付
**任务**：
- [ ] 编写使用文档
- [ ] 录制演示视频
- [ ] 代码注释完善
- [ ] 交付checklist

**产出**：
- 用户手册
- 开发文档
- 演示Demo

---

## 5. 技术债务管理

### 5.1 可选优化项（后续迭代）

**第二期优化**：
- [ ] 增量更新（只下载差异文件）
- [ ] CDN加速
- [ ] 多地域资源分发
- [ ] A/B测试能力
- [ ] 更精细的灰度策略

**第三期优化**：
- [ ] 离线包预置
- [ ] H5容器通用化
- [ ] 性能监控平台
- [ ] 智能预加载
- [ ] 资源按需加载

### 5.2 已知限制

1. **当前版本限制**：
   - 暂不支持增量更新
   - WebView池大小固定为3
   - 仅支持单一商城场景

2. **兼容性限制**：
   - iOS最低支持 iOS 12
   - Android最低支持 Android 5.0
   - Flutter SDK >= 3.3.0

---

## 6. 风险评估与应对

### 6.1 技术风险

| 风险项 | 概率 | 影响 | 应对措施 |
|--------|------|------|---------|
| WebView兼容性问题 | 中 | 高 | 充分测试，准备降级方案 |
| 资源包过大下载慢 | 高 | 中 | 资源压缩，分包加载 |
| 内存占用过高 | 中 | 高 | 限制池大小，及时释放 |
| JSBridge性能瓶颈 | 低 | 中 | 批量处理，异步执行 |

### 6.2 进度风险

**风险**：某个环节超时影响整体进度

**应对**：
- 每日站会同步进度
- 提前识别阻塞项
- 准备备选方案
- 核心功能优先保证

---

## 7. 质量保证

### 7.1 代码质量

**要求**：
- [ ] 代码Review覆盖率100%
- [ ] 关键路径单元测试
- [ ] Lint检查通过
- [ ] 无明显性能问题

### 7.2 测试覆盖

**测试类型**：
- 单元测试（核心逻辑）
- 集成测试（端到端流程）
- 性能测试（基准测试）
- 兼容性测试（多设备）
- 异常场景测试（容错能力）

### 7.3 交付标准

**必须满足**：
1. 所有核心功能可演示
2. 首屏加载 < 300ms
3. 资源加载成功率 > 95%
4. 无严重Bug
5. 文档齐全

---

## 8. 项目复盘

### 8.1 复盘内容

**技术层面**：
- 架构设计是否合理
- 技术选型是否正确
- 性能是否达标
- 代码质量如何

**管理层面**：
- 进度控制是否有效
- 资源分配是否合理
- 风险应对是否及时
- 团队协作是否顺畅

### 8.2 经验沉淀

**输出物**：
- 技术方案文档
- 最佳实践总结
- 踩坑记录
- 优化建议

---

## 9. 后续规划

### 9.1 短期优化（1个月内）

- 根据用户反馈优化体验
- 修复线上问题
- 性能持续调优
- 补充测试用例

### 9.2 中期规划（3个月内）

- 支持更多H5页面
- 增量更新能力
- 监控平台建设
- 容器通用化

### 9.3 长期规划（6个月内）

- 构建完整的动态化平台
- 支持多业务接入
- 智能化预加载
- 性能自动优化

---

## 10. 附录

### 10.1 技术栈清单

**后端**：
- Node.js + Express
- TypeScript
- 文件系统操作

**Flutter**：
- webview_flutter ^4.4.0
- dio ^5.4.0
- crypto ^3.0.3
- path_provider ^2.1.0
- archive ^3.4.0

**H5**：
- React 18
- Vite 5
- TypeScript 5

### 10.2 参考资料

- [Flutter WebView官方文档](https://pub.dev/packages/webview_flutter)
- [JSBridge最佳实践](https://github.com/marcuswestin/WebViewJavascriptBridge)
- [混合开发架构设计](相关技术文章)

---

## 总结

本规划涵盖了从基础搭建到优化加固的完整过程，预计15个工作日完成。

**关键成功因素**：
1. 严格按照节点推进
2. 及时沟通解决问题
3. 重点保证核心功能
4. 持续优化用户体验

**验收重点**：
- 功能完整性
- 性能达标
- 稳定性保证
- 文档齐全

待您审阅后，我们可以开始实际的代码开发工作。

