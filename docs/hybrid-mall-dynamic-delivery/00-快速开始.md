# Flutter混合商城动态化 - 快速开始

## 📚 文档导航

本项目包含完整的技术方案设计文档，按阅读顺序：

### 核心设计文档
1. **[README.md](./README.md)** - 项目总览
2. **[01-整体架构设计.md](./01-整体架构设计.md)** - 系统架构、技术选型、数据流设计
3. **[02-资源包管理方案.md](./02-资源包管理方案.md)** - 资源包结构、版本管理、下载校验、原子化安装
4. **[03-原生交互方案.md](./03-原生交互方案.md)** - JSBridge设计、双向通信、大数据传输优化
5. **[04-性能优化方案.md](./04-性能优化方案.md)** - 骨架屏、WebView池、秒开优化、资源预加载
6. **[05-容错降级方案.md](./05-容错降级方案.md)** - 多层降级、错误捕获、Crash防护、监控告警
7. **[06-实施节点规划.md](./06-实施节点规划.md)** - 15天实施计划、验收标准、风险管理

### 深度专题文档
8. **[07-Flutter与JS交互原理详解.md](./07-Flutter与JS交互原理详解.md)** - 底层通信机制深度剖析
9. **[08-原生iOS与Flutter方案对比.md](./08-原生iOS与Flutter方案对比.md)** - 技术差异全面对比
10. **[09-内置资源包策略.md](./09-内置资源包策略.md)** - 首次体验优化方案
11. **[10-Flutter-JS交互最佳实践.md](./10-Flutter-JS交互最佳实践.md)** - 重点难点与性能优化
12. **[11-Flutter-Native-Platform-Channel详解.md](./11-Flutter-Native-Platform-Channel详解.md)** - Platform Channel深度解析

## 🎯 核心功能

### 1. 动态化能力
- ✅ 商城H5资源包动态下发
- ✅ 版本管理和增量更新  
- ✅ SHA256完整性校验
- ✅ 原子化加载机制

### 2. 原生交互
- ✅ H5调用Native（获取用户信息、导航跳转、显示Toast等）
- ✅ Native调用JS（主题变化、网络状态通知等）
- ✅ 双向回调机制
- ✅ 批量事件上报（大数据量优化）

### 3. 性能优化
- ✅ 骨架屏 + JS注入（视觉优化）
- ✅ WebView池预加载（秒开优化）
- ✅ 关键资源预加载
- ✅ 首屏时间 < 300ms

### 4. 稳定性保障
- ✅ 三级降级策略（缓存版本→内置版本→错误页）
- ✅ WebView Crash自动重启
- ✅ 网络异常处理
- ✅ 错误日志上报

## 🏗️ 技术架构

```
┌─────────────────────────────────────────┐
│           Flutter Shell                 │
│  ┌─────────────┐  ┌──────────────┐     │
│  │ WebView Pool│  │  JSBridge    │     │
│  └─────────────┘  └──────────────┘     │
│  ┌─────────────────────────────────┐   │
│  │    ResourceManager              │   │
│  │  (下载/校验/加载)                │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
              ↕ HTTPS
┌─────────────────────────────────────────┐
│        Node.js 后端服务 (3001)          │
│  ┌──────────┐  ┌───────────────┐       │
│  │资源服务器│  │ 版本管理API   │       │
│  └──────────┘  └───────────────┘       │
└─────────────────────────────────────────┘
```

## 📦 资源包结构

```
mall-v1.0.0.zip
├── manifest.json          # 元数据（版本、checksum等）
├── index.html            # 入口页面
└── assets/
    ├── js/               # React打包产物
    ├── css/              # 样式文件
    └── images/           # 图片资源
```

## 🔄 核心流程

### 启动流程
```
App启动
  ↓
检查本地版本
  ↓
请求服务器版本信息
  ├─ 有新版本 → 下载 → 校验 → 解压 → 原子安装
  └─ 无新版本 → 直接使用本地版本
  ↓
初始化WebView池
  ↓
加载商城HTML
  ↓
注入JSBridge
  ↓
页面渲染完成
```

### 降级流程
```
加载失败
  ↓
尝试使用上一个可用版本
  ├─ 成功 → 继续使用
  └─ 失败 ↓
使用App内置兜底版本
  ├─ 成功 → 继续使用
  └─ 失败 ↓
显示原生错误页 + 重试按钮
```

## 📊 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 首屏加载时间 | < 300ms | WebView显示到内容可见 |
| 资源加载成功率 | > 99% | 成功加载资源的比例 |
| WebView Crash率 | < 0.1% | 每千次访问崩溃次数 |
| 秒开成功率 | > 95% | 使用WebView池后 |
| 内存占用 | < 150MB | 包含WebView和资源 |

## ⏱️ 实施周期

**总工期**: 15个工作日（3周）

```
Week 1: 基础设施搭建
  Day 1-2: 后端资源服务
  Day 3-4: Flutter资源管理  
  Day 5:   H5商城资源包

Week 2: 核心功能实现
  Day 6-7:  JSBridge通信
  Day 8-9:  资源下载加载
  Day 10:   集成测试

Week 3: 优化与加固
  Day 11-12: 性能优化（骨架屏、WebView池）
  Day 13-14: 容错降级（错误捕获、降级策略）
  Day 15:    总体验收
```

## 🔧 技术栈

### 后端（Node.js - localhost:3001）
- Express - HTTP框架
- 静态资源服务
- 版本管理API
- SHA256校验

### Flutter端
- `webview_flutter: ^4.4.0` - WebView容器
- `dio: ^5.4.0` - HTTP客户端（已有）
- `crypto: ^3.0.3` - 完整性校验（已有）
- `path_provider: ^2.1.0` - 文件路径
- `archive: ^3.4.0` - 解压缩

### H5前端（React）
- React 18
- Vite 5
- TypeScript
- 自研JSBridge SDK

## 🚀 快速开始

### 第一步：阅读文档
按顺序阅读01-06的技术方案文档，理解整体设计思路。

### 第二步：环境准备
- Node.js环境（后端服务）
- Flutter开发环境
- React开发环境

### 第三步：等待指令
文档已完成，等待您的指令开始代码开发。

## 📋 验收清单

### 功能验收
- [ ] 资源动态下发完整流程
- [ ] 版本管理和校验
- [ ] 原子化更新
- [ ] H5 ↔ Native双向通信
- [ ] 批量事件上报
- [ ] 骨架屏优化
- [ ] WebView池秒开
- [ ] 错误降级机制
- [ ] Crash防护

### 性能验收
- [ ] 首屏加载 < 300ms
- [ ] 资源加载成功率 > 95%
- [ ] 内存占用 < 150MB
- [ ] WebView Crash率 < 0.1%

### 质量验收
- [ ] 核心代码Review
- [ ] 单元测试覆盖
- [ ] 异常场景测试
- [ ] 文档完整

## 🎓 关键技术点

### 1. 原子化更新
通过「下载到临时目录 → 校验 → 原子重命名」确保更新过程中应用始终可用。

### 2. WebView池化
预创建3个WebView实例，复用时加载速度从秒级降到毫秒级。

### 3. 多层降级
新版本 → 缓存版本 → 内置版本 → 错误页，确保任何情况下都能展示。

### 4. 批量上报
累积50个事件或5秒间隔批量上报，避免频繁通信影响性能。

### 5. JSBridge通信
标准消息协议 + 回调管理 + 超时控制，实现可靠的跨端通信。

## 📞 后续计划

完成本期开发后，可考虑：
- 增量更新（差异包）
- CDN加速
- A/B测试能力
- 更多业务场景接入
- 监控平台建设

---

**当前状态**: ✅ 技术方案已完成，等待开始代码开发

**下一步**: 等待您的指令，我们将按照[06-实施节点规划](./06-实施节点规划.md)开始具体的代码实现。

