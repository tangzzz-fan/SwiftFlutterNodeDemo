# 容错降级方案

## 1. 整体降级策略

### 1.1 分层降级体系

```
┌─────────────────────────────────────────────────┐
│              正常加载流程                        │
│  检查版本 → 下载资源 → 校验 → 加载WebView        │
└─────────────────────────────────────────────────┘
                    │ 任何环节失败
                    ▼
┌─────────────────────────────────────────────────┐
│            第一级降级：使用本地缓存版本            │
│  加载上一个成功的版本（如 v1.0.0）               │
└─────────────────────────────────────────────────┘
                    │ 本地版本也失败
                    ▼
┌─────────────────────────────────────────────────┐
│         第二级降级：使用内置兜底资源包             │
│  加载打包在App内的基础版本（assets/mall.zip）     │
└─────────────────────────────────────────────────┘
                    │ 内置版本也失败
                    ▼
┌─────────────────────────────────────────────────┐
│        第三级降级：静态错误页面                   │
│  显示原生Flutter错误提示页 + 重试按钮             │
└─────────────────────────────────────────────────┘
```

### 1.2 降级触发条件

| 错误类型 | 降级策略 | 上报级别 |
|---------|---------|---------|
| 网络超时/无网络 | 使用本地缓存 | INFO |
| 下载失败（3次重试后） | 使用本地缓存 | WARNING |
| 资源校验失败 | 删除异常文件，使用上一版本 | ERROR |
| WebView加载失败 | 降级到内置版本 | ERROR |
| JS执行错误 | 捕获错误，不中断页面 | WARNING |
| WebView Crash | 重启WebView，失败则降级 | CRITICAL |
| 内存不足 | 清理缓存，降级到轻量版 | WARNING |

## 2. 错误捕获机制

### 2.1 WebView错误捕获

**Flutter端捕获**：
- `onWebResourceError`: 资源加载错误
- `onHttpError`: HTTP错误（404、500等）
- `onNavigationRequest`: 导航拦截
- Platform Channel监听原生Crash

**H5端捕获**：
```javascript
// 全局错误捕获
window.addEventListener('error', (event) => {
  reportError({
    type: 'js_error',
    message: event.message,
    stack: event.error?.stack,
  });
});

// Promise错误捕获
window.addEventListener('unhandledrejection', (event) => {
  reportError({
    type: 'promise_rejection',
    reason: event.reason,
  });
});
```

### 2.2 错误分类与处理

```
错误分类树：
├── 可恢复错误（自动重试）
│   ├── 网络超时
│   ├── 临时性404
│   └── WebView轻微卡顿
├── 需降级错误（切换版本）
│   ├── 资源校验失败
│   ├── 加载超时（>10s）
│   └── 连续3次加载失败
└── 致命错误（显示错误页）
    ├── WebView Crash
    ├── 内存溢出
    └── 所有降级方案都失败
```

## 3. 资源加载容错

### 3.1 版本回退机制

**回退流程**：
```
1. 新版本加载失败
   ↓
2. 标记新版本为「不可用」
   ↓
3. 从版本历史中找到最近的「可用」版本
   ↓
4. 切换版本指针到可用版本
   ↓
5. 重新加载WebView
```

**版本状态管理**：
```json
{
  "versions": {
    "1.0.2": {
      "status": "failed",
      "failCount": 3,
      "lastFailTime": "2025-10-23T10:00:00Z"
    },
    "1.0.1": {
      "status": "available",
      "loadCount": 150,
      "successRate": 0.98
    },
    "1.0.0": {
      "status": "available",
      "loadCount": 1000,
      "successRate": 0.99
    }
  },
  "currentVersion": "1.0.1",
  "fallbackVersion": "1.0.0"
}
```

### 3.2 断点续传与重试

**下载重试策略**：
- 第1次失败：等待1秒重试
- 第2次失败：等待3秒重试
- 第3次失败：等待5秒重试
- 3次全失败：放弃本次更新，使用本地版本

**断点续传实现要点**：
1. 记录已下载字节数
2. 使用HTTP Range头续传
3. 校验已下载部分的完整性
4. 失败后从断点继续

### 3.3 网络状态适配

**网络检测**：
```
应用启动 → 检测网络
          ├─ WiFi：正常下载更新
          ├─ 4G/5G：询问用户是否下载（流量提醒）
          └─ 无网络：直接使用本地缓存
```

**弱网优化**：
- 启用资源压缩（gzip）
- 降低图片质量
- 延迟加载非关键资源
- 超时时间动态调整（弱网延长到30s）

## 4. WebView Crash防护

### 4.1 Crash检测

**检测手段**：
1. WebView进程退出监听
2. 页面白屏超过3秒检测
3. JS Bridge通信中断检测
4. 定时心跳检测（每5秒）

### 4.2 自动重启机制

**重启流程**：
```
Crash检测
  ↓
记录Crash次数 + 1
  ↓
判断：5分钟内Crash次数
  ├─ < 3次：自动重启WebView
  └─ >= 3次：停止重启，显示错误页
```

**重启策略**：
- 清理WebView缓存
- 重置JavaScriptChannel
- 重新注入Bridge
- 恢复到最后稳定状态

### 4.3 内存管理

**内存监控**：
- 定期检查WebView内存占用
- 超过阈值（150MB）时触发警告
- 超过危险值（200MB）时清理缓存
- 极限情况（250MB）强制降级到轻量版

**内存释放策略**：
1. 清理图片缓存
2. 释放不可见WebView
3. 减少WebView池大小
4. 触发JS GC（垃圾回收）

## 5. 降级页面设计

### 5.1 内置兜底页面

**设计原则**：
- 纯静态HTML，无外部依赖
- 体积极小（< 50KB）
- 展示基础功能入口
- 提供明确的错误提示

**内容结构**：
```html
<!DOCTYPE html>
<html>
<head>
  <style>/* 内联样式 */</style>
</head>
<body>
  <!-- 错误提示 -->
  <div class="error-message">
    <h2>页面加载遇到问题</h2>
    <p>正在为您切换到备用版本...</p>
  </div>
  
  <!-- 基础功能入口 -->
  <div class="quick-actions">
    <button onclick="retry()">重新加载</button>
    <button onclick="backToNative()">返回首页</button>
  </div>
  
  <script>
    // 最小化JS逻辑
    function retry() {
      window.location.reload();
    }
    function backToNative() {
      window.NativeBridge?.postMessage('{"method":"goBack"}');
    }
  </script>
</body>
</html>
```

### 5.2 原生错误页

**Flutter错误页组件**：
- 友好的错误提示文案
- 重试按钮
- 返回按钮
- 联系客服入口
- 错误代码显示（可选，调试用）

**错误页层级**：
```
ErrorPage
├── 网络错误页（无网络图标 + 检查网络提示）
├── 加载失败页（重试按钮 + 返回按钮）
├── 版本过低页（引导更新App）
└── 通用错误页（错误信息 + 错误码）
```

## 6. 错误日志与上报

### 6.1 日志分级

| 级别 | 说明 | 上报时机 | 示例 |
|------|------|---------|------|
| DEBUG | 调试信息 | 不上报 | WebView加载进度 |
| INFO | 一般信息 | 不上报 | 版本检查完成 |
| WARNING | 警告信息 | 批量上报 | 下载重试、弱网环境 |
| ERROR | 错误信息 | 实时上报 | 资源校验失败、加载失败 |
| CRITICAL | 严重错误 | 立即上报 | WebView Crash、内存溢出 |

### 6.2 错误上报内容

**上报数据结构**：
```json
{
  "errorId": "err_1698123456789",
  "level": "ERROR",
  "type": "resource_load_failed",
  "message": "Failed to load resource version 1.0.2",
  "context": {
    "currentVersion": "1.0.1",
    "targetVersion": "1.0.2",
    "networkType": "WiFi",
    "deviceInfo": {
      "platform": "iOS",
      "osVersion": "17.0",
      "appVersion": "1.0.0"
    },
    "errorStack": "...",
    "previousErrors": [...]
  },
  "timestamp": "2025-10-23T10:00:00Z"
}
```

### 6.3 日志本地存储

**存储策略**：
- 保留最近7天的日志
- 每天一个日志文件
- 文件大小超过5MB自动分片
- 错误日志单独存储（error.log）

**日志清理**：
- 每次启动检查日志大小
- 超过50MB时清理旧日志
- 保留最近3天的ERROR日志

## 7. 用户体验优化

### 7.1 透明降级

**用户无感知降级**：
- 优先使用缓存版本，不显示错误提示
- 后台静默重试
- 降级过程显示加载动画而非错误页
- 成功降级后正常使用，不打断用户

**需要提示的场景**：
- 首次安装无缓存时下载失败
- 所有降级方案都失败
- 版本过旧需要更新App

### 7.2 加载状态提示

**状态机设计**：
```
Initial State
  ↓
Checking Version (检查更新中...)
  ↓
Downloading (下载中 45%)
  ↓
Verifying (校验中...)
  ↓
Loading (加载中...)
  ↓
Ready (加载完成)

[任何环节失败] → Fallback State → Retry/Error Page
```

### 7.3 错误提示文案

**友好的错误文案**：
- ❌ "Network Error: ERR_CONNECTION_TIMEOUT"
- ✅ "网络连接超时，请检查网络后重试"

- ❌ "Resource verification failed: checksum mismatch"
- ✅ "资源加载异常，正在为您切换备用版本"

## 8. 监控与告警

### 8.1 关键指标监控

**实时监控指标**：
- 资源加载成功率（目标 > 99%）
- WebView Crash率（目标 < 0.1%）
- 降级触发次数
- 平均加载耗时
- 错误分布统计

### 8.2 告警规则

**告警触发条件**：
```
告警级别 P0（严重）：
- WebView Crash率 > 1%
- 资源加载失败率 > 10%
- 降级到兜底页的用户数 > 100

告警级别 P1（重要）：
- 资源加载失败率 > 5%
- 某个版本失败率 > 20%
- 新版本发布后1小时内失败 > 50次

告警级别 P2（一般）：
- 下载重试率 > 30%
- 弱网环境加载超时 > 50次/小时
```

### 8.3 降级决策自动化

**服务端灰度降级**：
```
服务端监控到：v1.0.2版本失败率突增至15%
  ↓
自动执行：
  1. 停止向新用户推送v1.0.2
  2. 通知已下载用户回滚到v1.0.1
  3. 触发告警通知开发团队
  4. 记录降级事件到日志
```

**客户端智能降级**：
- 记录每个版本的成功率
- 连续失败3次的版本自动标记为不可用
- 优先选择成功率高的版本

## 9. 测试验证

### 9.1 异常场景测试

**必测场景清单**：
- ✅ 无网络环境启动
- ✅ 下载过程中断网
- ✅ 下载完成后文件损坏（篡改checksum）
- ✅ WebView加载超时
- ✅ JS执行错误
- ✅ 内存不足情况
- ✅ 磁盘空间不足
- ✅ 并发加载多个WebView
- ✅ 快速切换页面（压力测试）
- ✅ 低端机型兼容性

### 9.2 降级流程验证

**验证步骤**：
1. 模拟新版本加载失败 → 验证降级到上一版本
2. 删除所有本地版本 → 验证降级到内置版本
3. 损坏内置版本 → 验证显示错误页
4. 连续触发3次Crash → 验证停止自动重启
5. 弱网环境 → 验证超时时间调整

### 9.3 性能基准测试

**基准指标**：
- 正常加载时间：< 300ms
- 降级加载时间：< 500ms
- 错误检测时间：< 1s
- 自动重启时间：< 2s

## 10. 回滚预案

### 10.1 快速回滚方案

**服务端回滚**：
```
发现问题 → 修改版本配置 → 推送回滚通知
  ↓
客户端收到通知 → 立即切换到指定版本 → 清除问题版本
```

**客户端自主回滚**：
- 检测到异常自动回滚
- 提供手动回滚入口（设置页）
- 管理员远程触发回滚

### 10.2 回滚验证

**回滚后验证**：
1. 检查版本号是否正确切换
2. 验证功能是否正常
3. 确认错误率是否下降
4. 监控用户反馈

## 11. 最佳实践总结

### 11.1 设计原则

1. **多层降级**：不要依赖单一降级方案
2. **快速失败**：尽早检测问题，避免长时间等待
3. **透明降级**：优先用户体验，降级对用户无感知
4. **详细日志**：记录完整上下文，便于排查
5. **自动恢复**：问题解决后自动恢复到最新版本

### 11.2 注意事项

⚠️ **避免过度降级**：
- 不要一出错就降级到最低版本
- 给每个版本重试机会
- 记录降级历史，避免循环降级

⚠️ **性能开销**：
- 错误检测不要过于频繁
- 日志记录异步进行
- 上报数据批量处理

⚠️ **安全性**：
- 降级过程也要校验资源完整性
- 兜底页面防止XSS注入
- 不在错误信息中暴露敏感数据

## 下一步

详见：[实施节点规划](./06-实施节点规划.md)

